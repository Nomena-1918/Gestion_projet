import{_,a as u,o as d,c as a,b as s,t as n,d as q,w as p,v as h,F as g,r as v,e as m,f,g as E,h as y,n as C}from"./index-c433af20.js";const b={data(){return{user:JSON.parse(localStorage.getItem("user"))||null,showProfileMenu:!1,episode:{scenariste:null,realisateur:null},sequences:[],statutsSequence:[],accessDenied:!1,userEpisodes:[],filterTimePeriod:"all",filterStatut:"",showEditModal:!1,editingSequence:{idSequence:null,titre:"",synopsis:"",ordre:null,statutId:null},showCommentSection:!1,newComment:"",comments:[],commentCount:0,editError:"",orderError:"",suggestedOrder:null,existingOrders:[],originalOrder:null}},computed:{userInitials(){var e;return(e=this.user)!=null&&e.nom?this.user.nom.split(" ").map(l=>l[0]).join("").toUpperCase():""},filteredSequences(){let t=this.sequences;this.filterStatut&&(t=t.filter(l=>l.statutNom===this.filterStatut));const e=new Date;return t=t.filter(l=>{const c=new Date(l.modifieLe);switch(this.filterTimePeriod){case"today":return c.toDateString()===e.toDateString();case"this_week":const o=new Date(e);return o.setDate(e.getDate()-7),c>=o;case"this_month":return c.getMonth()===e.getMonth()&&c.getFullYear()===e.getFullYear();case"this_year":return c.getFullYear()===e.getFullYear();case"recent":const r=new Date(e);return r.setDate(e.getDate()-7),c>=r;default:return!0}}),t}},async created(){await this.loadUserEpisodes(),await this.checkAccess(),this.accessDenied||(await this.loadEpisode(),await this.loadSequences(),await this.loadStatutsSequence(),await this.loadCommentCount()),document.addEventListener("click",this.handleClickOutside)},beforeDestroy(){document.removeEventListener("click",this.handleClickOutside)},methods:{async loadUserEpisodes(){try{const t=await u.get(`/api/episodes/utilisateur/${this.user.id}`);this.userEpisodes=t.data}catch(t){console.error("Erreur lors du chargement des √©pisodes utilisateur:",t)}},async checkAccess(){const t=parseInt(this.$route.params.id);if(this.user.role==="ADMIN"){this.accessDenied=!1;return}this.userEpisodes.some(l=>l.idEpisode===t)||(this.accessDenied=!0)},async loadEpisode(){var t;try{const e=await u.get(`/api/episodes/${this.$route.params.id}`,{headers:{"X-User-Id":this.user.id}});this.episode=e.data,console.log("Donn√©es de l'√©pisode:",this.episode),console.log("Sc√©nariste:",this.episode.scenariste),console.log("R√©alisateur:",this.episode.realisateur)}catch(e){((t=e.response)==null?void 0:t.status)===403?this.accessDenied=!0:console.error("Erreur lors du chargement de l'√©pisode:",e)}},async loadSequences(){try{const t=await u.get(`/api/sequences/episodes/${this.$route.params.id}`,{headers:{"X-User-Id":this.user.id}});this.sequences=t.data}catch(t){console.error("Erreur lors du chargement des s√©quences:",t)}},async loadStatutsSequence(){try{const t=await u.get("/api/statuts-sequence");this.statutsSequence=t.data}catch(t){console.error("Erreur lors du chargement des statuts:",t)}},async loadComments(){try{const t=await u.get(`/api/commentaires/episode/${this.$route.params.id}`);this.comments=t.data}catch(t){console.error("Erreur lors du chargement des commentaires:",t)}},async loadCommentCount(){try{const t=await u.get(`/api/commentaires/episode/${this.$route.params.id}/count`);this.commentCount=t.data}catch(t){console.error("Erreur lors du chargement du nombre de commentaires:",t)}},async toggleCommentSection(){this.showCommentSection=!this.showCommentSection,this.showCommentSection&&await this.loadComments()},async addComment(){if(this.newComment.trim())try{await u.post("/api/commentaires",{contenu:this.newComment,episodeId:this.$route.params.id},{headers:{"X-User-Id":this.user.id}}),this.newComment="",await this.loadComments(),await this.loadCommentCount()}catch(t){console.error("Erreur lors de l'ajout du commentaire:",t),alert("Erreur lors de l'ajout du commentaire")}},async deleteComment(t){if(confirm("√ätes-vous s√ªr de vouloir supprimer ce commentaire ?"))try{await u.delete(`/api/commentaires/${t}`),await this.loadComments(),await this.loadCommentCount()}catch(e){console.error("Erreur lors de la suppression du commentaire:",e)}},startEditSequence(t){this.editingSequence={idSequence:t.idSequence,titre:t.titre,synopsis:t.synopsis,ordre:t.ordre,statutId:this.getStatutIdByNom(t.statutNom)},this.originalOrder=t.ordre,this.showEditModal=!0,this.loadExistingOrders()},async loadExistingOrders(){try{const t=await u.get(`/api/sequences/episodes/${this.$route.params.id}`);this.existingOrders=t.data.filter(e=>e.idSequence!==this.editingSequence.idSequence).map(e=>e.ordre),this.calculateSuggestedOrder()}catch(t){console.error("Erreur lors du chargement des ordres existants:",t)}},calculateSuggestedOrder(){if(this.existingOrders.length===0)this.suggestedOrder=1;else{const t=Math.max(...this.existingOrders);this.suggestedOrder=t+1}},validateOrder(){if(!this.editingSequence.ordre){this.orderError="L'ordre est requis";return}const t=parseInt(this.editingSequence.ordre);if(t<1){this.orderError="L'ordre doit √™tre un nombre positif";return}if(this.existingOrders.includes(t)&&t!==this.originalOrder){this.orderError=`L'ordre ${t} existe d√©j√† pour cet √©pisode. Veuillez choisir un autre num√©ro.`;return}this.orderError=""},useSuggestedOrder(){this.editingSequence.ordre=this.suggestedOrder,this.validateOrder()},getStatutIdByNom(t){const e=this.statutsSequence.find(l=>l.nomStatutsSequence===t);return e?e.id:null},async saveEditedSequence(){var t,e,l,c,o,r;if(this.validateOrder(),!this.orderError)try{const i=await u.put(`/api/sequences/${this.editingSequence.idSequence}`,{titre:this.editingSequence.titre,synopsis:this.editingSequence.synopsis,ordre:parseInt(this.editingSequence.ordre),statutId:this.editingSequence.statutId});this.showEditModal=!1,this.editError="",this.orderError="",await this.loadSequences()}catch(i){console.error("Erreur lors de la mise √† jour de la s√©quence:",i),((t=i.response)==null?void 0:t.status)===400&&((c=(l=(e=i.response)==null?void 0:e.data)==null?void 0:l.message)!=null&&c.includes("ordre"))?(this.orderError="Cet ordre existe d√©j√† pour cet √©pisode. Veuillez choisir un autre num√©ro.",this.editError="Erreur de validation: "+this.orderError):this.editError=((r=(o=i.response)==null?void 0:o.data)==null?void 0:r.message)||"Erreur lors de la mise √† jour de la s√©quence"}},closeEditModal(){this.showEditModal=!1,this.editingSequence={idSequence:null,titre:"",synopsis:"",ordre:null,statutId:null},this.editError="",this.orderError="",this.suggestedOrder=null,this.existingOrders=[],this.originalOrder=null},async confirmDeleteSequence(t){if(confirm("√ätes-vous s√ªr de vouloir supprimer cette s√©quence ?"))try{await u.delete(`/api/sequences/${t}`),await this.loadSequences()}catch(e){console.error("Erreur lors de la suppression de la s√©quence:",e)}},goToAddSequence(){this.$router.push(`/episode/${this.episode.idEpisode}/add-sequence`)},goToSequenceDetails(t){this.$router.push(`/sequence/${t}/detail-sequence`)},goBack(){this.$router.push(`/projet/${this.episode.projetId}`)},formatDate(t){return new Date(t).toLocaleString()},truncateText(t,e){return t?t.length<=e?t:t.substring(0,e)+"...":""},toggleProfileMenu(){this.showProfileMenu=!this.showProfileMenu},handleClickOutside(t){t.target.closest(".profile-section")||(this.showProfileMenu=!1)},seDeconnecter(){localStorage.removeItem("user"),localStorage.removeItem("token"),this.$router.push("/")}}},w={class:"episode-details-container"},k={key:0,class:"access-denied"},D={class:"access-denied-content"},O={key:1,class:"main-content"},x={class:"episode-header"},I={class:"episode-details"},M={class:"episode-info"},T={class:"episode-main"},A={class:"episode-synopsis"},N={key:0,class:"comment-section"},j={class:"add-comment"},L={class:"comments-list"},U={class:"comment-header"},V={class:"comment-author"},B={class:"comment-date"},P={class:"comment-content"},F={key:0,class:"comment-actions"},R=["onClick"],z={class:"episode-sidebar"},Y={class:"episode-statut"},X={class:"statut-value"},J={class:"episode-date"},W={class:"date-value"},G={key:0,class:"episode-team"},H={class:"team-member"},K={class:"member-name"},Q={class:"member-email"},Z={key:1,class:"episode-team"},$={key:2,class:"episode-team"},ee={class:"team-member"},se={class:"member-name"},te={class:"member-email"},ie={key:3,class:"episode-team"},oe={class:"episode-date"},re={class:"date-value"},ne={class:"episode-date"},de={class:"date-value"},ae={key:4,class:"episode-date"},le={class:"date-value"},ue={class:"sequences-section"},ce={class:"section-header"},me={class:"filters"},pe={class:"filter-group"},he={class:"filter-group"},ge=["value"],ve={class:"sequences-list"},Se={class:"sequence-header"},fe={class:"sequence-statut"},qe={class:"sequence-actions"},ye=["onClick"],_e=["onClick"],Ee={class:"sequence-content"},Ce={class:"sequence-order"},be={class:"sequence-dates"},we={key:0,class:"sequence-synopsis"},ke={class:"sequence-footer"},De=["onClick"],Oe={key:0,class:"error-message"},xe={class:"form-group"},Ie={class:"form-group"},Me={class:"form-group"},Te={key:0,class:"error-text"},Ae={key:1,class:"suggestion-text"},Ne={class:"form-group"},je=["value"],Le={class:"form-group"},Ue=["value"],Ve={class:"modal-actions"},Be=["disabled"];function Pe(t,e,l,c,o,r){return d(),a("div",w,[o.accessDenied?(d(),a("div",k,[s("div",D,[e[18]||(e[18]=s("i",{class:"fas fa-exclamation-triangle"},null,-1)),e[19]||(e[19]=s("h3",null,"Acc√®s refus√©",-1)),e[20]||(e[20]=s("p",null,"Vous n'avez pas les droits n√©cessaires pour acc√©der √† cet √©pisode.",-1)),s("button",{onClick:e[0]||(e[0]=(...i)=>r.goBack&&r.goBack(...i)),class:"back-btn"},"Retour au projet")])])):(d(),a("main",O,[s("div",x,[s("button",{onClick:e[1]||(e[1]=(...i)=>r.goBack&&r.goBack(...i)),class:"back-btn"},"‚Üê Retour"),e[21]||(e[21]=s("h2",null,"D√©tails de l'√âpisode",-1))]),s("div",I,[s("div",M,[s("div",T,[s("h3",null,n(o.episode.titre),1),s("div",A,[s("h4",null,[e[22]||(e[22]=q(" Synopsis ",-1)),s("span",{class:"comment-icon",onClick:e[2]||(e[2]=(...i)=>r.toggleCommentSection&&r.toggleCommentSection(...i))}," üí¨ "+n(o.commentCount),1)]),s("p",null,n(o.episode.synopsis||"Aucun synopsis disponible"),1),o.showCommentSection?(d(),a("div",N,[e[23]||(e[23]=s("h5",null,"Commentaires",-1)),s("div",j,[p(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=i=>o.newComment=i),placeholder:"Ajouter un commentaire...",rows:"3"},null,512),[[h,o.newComment]]),s("button",{onClick:e[4]||(e[4]=(...i)=>r.addComment&&r.addComment(...i)),class:"add-comment-btn"},"Ajouter")]),s("div",L,[(d(!0),a(g,null,v(o.comments,i=>(d(),a("div",{key:i.id,class:"comment-item"},[s("div",U,[s("span",V,n(i.utilisateurNom),1),s("span",B,n(r.formatDate(i.creeLe)),1)]),s("div",P,n(i.contenu),1),i.utilisateurId===o.user.id?(d(),a("div",F,[s("button",{onClick:S=>r.deleteComment(i.id),class:"delete-comment-btn"},"Supprimer",8,R)])):m("",!0)]))),128))])])):m("",!0)])]),s("div",z,[s("div",Y,[e[24]||(e[24]=s("span",{class:"statut-label"},"Statut:",-1)),s("span",X,n(o.episode.statutNom),1)]),s("div",J,[e[25]||(e[25]=s("span",{class:"date-label"},"Ordre:",-1)),s("span",W,n(o.episode.ordre),1)]),o.episode.scenariste?(d(),a("div",G,[e[26]||(e[26]=s("span",{class:"team-label"},"Sc√©nariste:",-1)),s("div",H,[s("span",K,n(o.episode.scenariste.nom),1),s("span",Q,n(o.episode.scenariste.email),1)])])):(d(),a("div",Z,[...e[27]||(e[27]=[s("span",{class:"team-label"},"Sc√©nariste:",-1),s("span",{class:"team-value"},"Non assign√©",-1)])])),o.episode.realisateur?(d(),a("div",$,[e[28]||(e[28]=s("span",{class:"team-label"},"R√©alisateur:",-1)),s("div",ee,[s("span",se,n(o.episode.realisateur.nom),1),s("span",te,n(o.episode.realisateur.email),1)])])):(d(),a("div",ie,[...e[29]||(e[29]=[s("span",{class:"team-label"},"R√©alisateur:",-1),s("span",{class:"team-value"},"Non assign√©",-1)])])),s("div",oe,[e[30]||(e[30]=s("span",{class:"date-label"},"Cr√©√© le:",-1)),s("span",re,n(r.formatDate(o.episode.creeLe)),1)]),s("div",ne,[e[31]||(e[31]=s("span",{class:"date-label"},"Modifi√© le:",-1)),s("span",de,n(r.formatDate(o.episode.modifieLe)),1)]),o.episode.dateFin?(d(),a("div",ae,[e[32]||(e[32]=s("span",{class:"date-label"},"Termin√© le:",-1)),s("span",le,n(r.formatDate(o.episode.dateFin)),1)])):m("",!0)])])]),s("div",ue,[s("div",ce,[e[33]||(e[33]=s("h3",null,"S√©quences",-1)),s("button",{class:"add-sequence-btn",onClick:e[5]||(e[5]=(...i)=>r.goToAddSequence&&r.goToAddSequence(...i))},"+ S√©quence")]),s("div",me,[s("div",pe,[e[35]||(e[35]=s("label",null,"P√©riode de mise √† jour:",-1)),p(s("select",{"onUpdate:modelValue":e[6]||(e[6]=i=>o.filterTimePeriod=i)},[...e[34]||(e[34]=[E('<option value="all" data-v-2c0aa323>Toutes les p√©riodes</option><option value="today" data-v-2c0aa323>Aujourd&#39;hui</option><option value="this_week" data-v-2c0aa323>Cette semaine</option><option value="this_month" data-v-2c0aa323>Ce mois-ci</option><option value="this_year" data-v-2c0aa323>Cette ann√©e</option><option value="recent" data-v-2c0aa323>R√©cent (7 derniers jours)</option>',6)])],512),[[f,o.filterTimePeriod]])]),s("div",he,[e[37]||(e[37]=s("label",null,"Statut:",-1)),p(s("select",{"onUpdate:modelValue":e[7]||(e[7]=i=>o.filterStatut=i)},[e[36]||(e[36]=s("option",{value:""},"Tous",-1)),(d(!0),a(g,null,v(o.statutsSequence,i=>(d(),a("option",{key:i.id,value:i.nomStatutsSequence},n(i.nomStatutsSequence),9,ge))),128))],512),[[f,o.filterStatut]])])]),s("div",ve,[(d(!0),a(g,null,v(r.filteredSequences,i=>(d(),a("div",{key:i.idSequence,class:"sequence-card"},[s("div",Se,[s("div",fe,n(i.statutNom),1),s("div",qe,[s("span",{class:"icon-edit",onClick:S=>r.startEditSequence(i)},"‚úèÔ∏è",8,ye),s("span",{class:"icon-delete",onClick:S=>r.confirmDeleteSequence(i.idSequence)},"üóëÔ∏è",8,_e)])]),s("div",Ee,[s("h4",null,n(i.titre),1),s("p",Ce,"Ordre: "+n(i.ordre),1),s("div",be,[s("p",null,"Cr√©√© le: "+n(r.formatDate(i.creeLe)),1),s("p",null,"Modifi√© le: "+n(r.formatDate(i.modifieLe)),1)]),i.synopsis?(d(),a("div",we,[s("p",null,n(r.truncateText(i.synopsis,100)),1)])):m("",!0),s("div",ke,[s("button",{class:"details-btn",onClick:S=>r.goToSequenceDetails(i.idSequence)},"D√©tails",8,De)])])]))),128))])]),o.showEditModal?(d(),a("div",{key:0,class:"modal-overlay",onClick:e[17]||(e[17]=(...i)=>r.closeEditModal&&r.closeEditModal(...i))},[s("div",{class:"modal-content",onClick:e[16]||(e[16]=y(()=>{},["stop"]))},[e[43]||(e[43]=s("h3",null,"Modifier la S√©quence",-1)),o.editError?(d(),a("div",Oe,n(o.editError),1)):m("",!0),s("form",{onSubmit:e[15]||(e[15]=y((...i)=>r.saveEditedSequence&&r.saveEditedSequence(...i),["prevent"]))},[s("div",xe,[e[38]||(e[38]=s("label",null,"Titre de la s√©quence:",-1)),p(s("input",{"onUpdate:modelValue":e[8]||(e[8]=i=>o.editingSequence.titre=i),type:"text",required:""},null,512),[[h,o.editingSequence.titre]])]),s("div",Ie,[e[39]||(e[39]=s("label",null,"Synopsis:",-1)),p(s("textarea",{"onUpdate:modelValue":e[9]||(e[9]=i=>o.editingSequence.synopsis=i),required:""},null,512),[[h,o.editingSequence.synopsis]])]),s("div",Me,[e[40]||(e[40]=s("label",null,"Ordre dans l'√©pisode:",-1)),p(s("input",{"onUpdate:modelValue":e[10]||(e[10]=i=>o.editingSequence.ordre=i),type:"number",required:"",class:C({"error-input":o.orderError}),onBlur:e[11]||(e[11]=(...i)=>r.validateOrder&&r.validateOrder(...i))},null,34),[[h,o.editingSequence.ordre]]),o.orderError?(d(),a("div",Te,n(o.orderError),1)):m("",!0),o.suggestedOrder&&!o.editingSequence.ordre?(d(),a("div",Ae,[q(" Suggestion: Le prochain ordre disponible est "+n(o.suggestedOrder)+" ",1),s("button",{type:"button",onClick:e[12]||(e[12]=(...i)=>r.useSuggestedOrder&&r.useSuggestedOrder(...i)),class:"suggestion-btn"}," Utiliser cette valeur ")])):m("",!0)]),s("div",Ne,[e[41]||(e[41]=s("label",null,"Titre de l'√©pisode:",-1)),s("input",{value:o.episode.titre,type:"text",disabled:""},null,8,je)]),s("div",Le,[e[42]||(e[42]=s("label",null,"Statut:",-1)),p(s("select",{"onUpdate:modelValue":e[13]||(e[13]=i=>o.editingSequence.statutId=i),required:""},[(d(!0),a(g,null,v(o.statutsSequence,i=>(d(),a("option",{key:i.id,value:i.id},n(i.nomStatutsSequence),9,Ue))),128))],512),[[f,o.editingSequence.statutId]])]),s("div",Ve,[s("button",{type:"submit",class:"save-btn",disabled:o.orderError!==""},"Sauvegarder",8,Be),s("button",{type:"button",onClick:e[14]||(e[14]=(...i)=>r.closeEditModal&&r.closeEditModal(...i)),class:"cancel-btn"},"Annuler")])],32)])])):m("",!0)]))])}const Re=_(b,[["render",Pe],["__scopeId","data-v-2c0aa323"]]);export{Re as default};
