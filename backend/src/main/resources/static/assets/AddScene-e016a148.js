import{_ as S,a as c,o as i,c as d,b as s,h as b,w as g,v as m,n as O,d as q,t as u,e as p,f as y,F as x,r as E}from"./index-c433af20.js";const k={data(){return{user:JSON.parse(localStorage.getItem("user"))||null,showProfileMenu:!1,scene:{titre:"",ordre:null,synopsis:"",statutId:null},statutsScene:[],sequenceTitre:"",loading:!1,errorMessage:"",existingOrders:[],suggestedOrder:null,orderError:""}},computed:{userInitials(){var e;return(e=this.user)!=null&&e.nom?this.user.nom.split(" ").map(l=>l[0]).join("").toUpperCase():""},sequenceId(){return this.$route.params.sequenceId}},async created(){await this.loadStatutsScene(),await this.loadSequenceDetails(),await this.loadExistingOrders(),document.addEventListener("click",this.handleClickOutside)},beforeDestroy(){document.removeEventListener("click",this.handleClickOutside)},methods:{async loadStatutsScene(){try{const o=await c.get("/api/statuts-scene");this.statutsScene=o.data}catch(o){console.error("Erreur lors du chargement des statuts:",o),this.errorMessage="Erreur lors du chargement des statuts"}},async loadSequenceDetails(){try{const e=(await c.get(`/api/sequences/${this.sequenceId}`)).data;this.sequenceTitre=e.titre}catch(o){console.error("Erreur lors du chargement de la séquence:",o),this.errorMessage="Impossible de charger les détails de la séquence"}},async loadExistingOrders(){try{const o=await c.get(`/api/scenes/sequences/${this.sequenceId}`);this.existingOrders=o.data.map(e=>e.ordre),this.calculateSuggestedOrder()}catch(o){console.error("Erreur lors du chargement des ordres existants:",o),this.errorMessage="Impossible de vérifier les ordres existants"}},calculateSuggestedOrder(){if(this.existingOrders.length===0)this.suggestedOrder=1;else{const o=Math.max(...this.existingOrders);this.suggestedOrder=o+1}this.scene.ordre=this.suggestedOrder},validateOrder(){if(!this.scene.ordre){this.orderError="L'ordre est requis";return}if(this.scene.ordre<1){this.orderError="L'ordre doit être un nombre positif";return}if(this.existingOrders.includes(this.scene.ordre)){this.orderError=`L'ordre ${this.scene.ordre} existe déjà dans cette séquence`;return}this.orderError=""},useSuggestedOrder(){this.scene.ordre=this.suggestedOrder,this.validateOrder()},async submitScene(){var o,e,l,h,t,n,r,f,v;if(this.validateOrder(),this.orderError){this.errorMessage="Veuillez corriger les erreurs avant de soumettre";return}this.loading=!0,this.errorMessage="";try{await c.post(`/api/scenes/sequences/${this.sequenceId}`,this.scene),this.$router.push(`/sequence/${this.sequenceId}/detail-sequence`)}catch(a){console.error("Erreur lors de la création de la scène:",a),((o=a.response)==null?void 0:o.status)===400&&((h=(l=(e=a.response)==null?void 0:e.data)==null?void 0:l.message)!=null&&h.includes("ordre"))&&((r=(n=(t=a.response)==null?void 0:t.data)==null?void 0:n.message)!=null&&r.includes("existe"))?(this.orderError="Cet ordre existe déjà dans la séquence",this.errorMessage="Erreur de validation: "+this.orderError,await this.loadExistingOrders()):this.errorMessage=((v=(f=a.response)==null?void 0:f.data)==null?void 0:v.message)||"Erreur lors de la création de la scène"}finally{this.loading=!1}},goBack(){this.$router.go(-1)},toggleProfileMenu(){this.showProfileMenu=!this.showProfileMenu},handleClickOutside(o){o.target.closest(".profile-section")||(this.showProfileMenu=!1)},seDeconnecter(){localStorage.removeItem("user"),localStorage.removeItem("token"),this.$router.push("/")}}},_={class:"add-scene-container"},M={class:"main-content"},I={class:"scene-header"},w={class:"scene-form"},C={class:"form-group"},B={class:"form-group"},V={key:0,class:"suggestion-text"},L={key:1,class:"error-text"},D={class:"form-group"},T={class:"form-group"},U=["value"],P={class:"form-group"},j=["value"],A={key:0,class:"error-message"},N={class:"form-actions"},z=["disabled"];function R(o,e,l,h,t,n){return i(),d("div",_,[s("main",M,[s("div",I,[s("button",{onClick:e[0]||(e[0]=(...r)=>n.goBack&&n.goBack(...r)),class:"back-btn"},"← Retour"),e[9]||(e[9]=s("h2",null,"Ajouter une Scène",-1))]),s("div",w,[s("form",{onSubmit:e[8]||(e[8]=b((...r)=>n.submitScene&&n.submitScene(...r),["prevent"]))},[s("div",C,[e[10]||(e[10]=s("label",null,"Titre de la scène *",-1)),g(s("input",{"onUpdate:modelValue":e[1]||(e[1]=r=>t.scene.titre=r),type:"text",required:""},null,512),[[m,t.scene.titre]])]),s("div",B,[e[11]||(e[11]=s("label",null,"Ordre dans la séquence *",-1)),g(s("input",{"onUpdate:modelValue":e[2]||(e[2]=r=>t.scene.ordre=r),type:"number",min:"1",required:"",onBlur:e[3]||(e[3]=(...r)=>n.validateOrder&&n.validateOrder(...r)),class:O({"error-input":t.orderError})},null,34),[[m,t.scene.ordre]]),t.suggestedOrder?(i(),d("div",V,[q(" Suggestion: Le prochain ordre disponible est "+u(t.suggestedOrder)+" ",1),s("button",{type:"button",onClick:e[4]||(e[4]=(...r)=>n.useSuggestedOrder&&n.useSuggestedOrder(...r)),class:"suggestion-btn"}," Utiliser cette valeur ")])):p("",!0),t.orderError?(i(),d("div",L,u(t.orderError),1)):p("",!0)]),s("div",D,[e[12]||(e[12]=s("label",null,"Synopsis *",-1)),g(s("textarea",{"onUpdate:modelValue":e[5]||(e[5]=r=>t.scene.synopsis=r),required:""},null,512),[[m,t.scene.synopsis]])]),s("div",T,[e[13]||(e[13]=s("label",null,"Séquence liée",-1)),s("input",{value:t.sequenceTitre,type:"text",disabled:""},null,8,U)]),s("div",P,[e[15]||(e[15]=s("label",null,"Statut *",-1)),g(s("select",{"onUpdate:modelValue":e[6]||(e[6]=r=>t.scene.statutId=r),required:""},[e[14]||(e[14]=s("option",{value:""},"Sélectionnez un statut",-1)),(i(!0),d(x,null,E(t.statutsScene,r=>(i(),d("option",{key:r.id,value:r.id},u(r.nomStatutsScene),9,j))),128))],512),[[y,t.scene.statutId]])]),t.errorMessage?(i(),d("div",A,u(t.errorMessage),1)):p("",!0),s("div",N,[s("button",{type:"submit",class:"submit-btn",disabled:t.loading||t.orderError!==""},u(t.loading?"Création en cours...":"Créer la Scène"),9,z),s("button",{type:"button",onClick:e[7]||(e[7]=(...r)=>n.goBack&&n.goBack(...r)),class:"cancel-btn"}," Annuler ")])],32)])])])}const J=S(k,[["render",R],["__scopeId","data-v-6ca3af3b"]]);export{J as default};
